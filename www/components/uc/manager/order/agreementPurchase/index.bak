<template>
    <!-- 购买协议 -->
    <vb-mask :show="isShow">
        <div v-if="dealList.length && dealList.length === 1">
            <div v-for="(item, index) in dealList" :key="index">
                <div class="greementWrap">
                    <div class="gteementTitle">《 {{ item.skuName || item.productName || item.className }} 》</div>
                    <div v-if="btnType === 0" class="close" @click="close()"></div>
                    <div v-if="btnType === 1 && !disabled" class="close" @click="close()"></div>
                    <div v-if="btnType === 2 && !isCountDown" class="close" @click="close()"></div>
                    <div v-if="btnType === 3 && !isCountDown" class="close" @click="close()"></div>
                    <div class="greementCont" @scroll="scrollFn($event)" ref="el">
                        <buyreceipt
                            :order-id="orderId"
                            :class-id="choseItem.classId || choseItem.skuId"
                            :download-show="downloadShow"
                            @analysis="analysis"
                        ></buyreceipt>
                    </div>
                    <div class="footer" v-if="isShowFooter">
                        <div v-if="btnType == 0" :class="disabled ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                            <span>同意并确认签属产品协议</span>
                        </div>
                        <div v-if="btnType == 1" :class="disabled ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                            <span v-if="disabled">同意并确认签属产品协议</span>
                            <span v-if="disabled == true" class="slide">（协议内容下滑到底部并阅读完毕即可点击）</span>
                            <span v-else>同意并确认签属产品协议</span>
                        </div>
                        <div v-if="btnType == 2" :class="isCountDown ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                            <span v-if="isCountDown">({{ seconds }})秒 同意并确认签属产品协议</span>
                            <span v-else>同意并确认签属产品协议</span>
                        </div>
                        <div v-if="btnType == 3" :class="disabled || isCountDown ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                            <span v-if="isCountDown">({{ seconds }})秒 同意并确认签属产品协议</span>
                            <span v-if="!isCountDown && disabled">同意并确认签属产品协议</span>
                            <span v-if="disabled" class="slide">（协议内容下滑到底部并阅读完毕即可点击）</span>
                            <span v-if="!disabled && !isCountDown">同意并确认签属产品协议</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-if="dealList.length && dealList.length > 1">
            <div class="greementWrap">
                <div class="gteementTitle multi-protocol">
                    <div class="left fn" ref="left" v-if="leftFlag">
                        <img src="./asset/images/pre.png" alt="" @click="preFn" />
                    </div>
                    <div class="multi-protocol-content">
                        <ul class="content-item-wrap" ref="contentItemWrap">
                            <li
                                v-for="(item, index) in dealList"
                                :key="index"
                                @click="changeDeal(item, index)"
                                class="content-item"
                                :class="index == showIndex ? 'active' : ''"
                            >
                                {{ item.productName || item.className }}
                            </li>
                        </ul>
                    </div>
                    <div class="right fn" ref="right" v-if="rightFlag">
                        <img src="./asset/images/next.png" alt="" @click="nextFn" />
                    </div>
                </div>
                <div v-if="btnType === 0" class="closes" @click="close()"></div>
                <div v-if="btnType === 1 && !disabled" class="closes" @click="close()"></div>
                <div v-if="btnType === 2 && !isCountDown" class="closes" @click="close()"></div>
                <div v-if="btnType === 3 && !isCountDown" class="closes" @click="close()"></div>
                <div class="greementCont" @scroll="scrollFn($event)" ref="el">
                    <buyreceipt
                        :order-id="orderId"
                        :class-id="choseItem.classId || choseItem.skuId"
                        :download-show="downloadShow"
                        @analysis="analysis"
                    ></buyreceipt>
                </div>
                <div class="footer" v-if="isShowFooter">
                    <div v-if="btnType == 0" :class="disabled ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                        <span>同意并确认签属产品协议</span>
                    </div>
                    <div v-if="btnType == 1" :class="disabled ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                        <span v-if="disabled">同意并确认签属产品协议</span>
                        <span v-if="disabled == true" class="slide">（协议内容下滑到底部并阅读完毕即可点击）</span>
                        <span v-else>同意并确认签属产品协议</span>
                    </div>
                    <div v-if="btnType == 2" :class="isCountDown ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                        <span v-if="isCountDown">({{ seconds }})秒 同意并确认签属产品协议</span>
                        <span v-else>同意并确认签属产品协议</span>
                    </div>
                    <div v-if="btnType == 3" :class="disabled || isCountDown ? 'disable' : 'btn-wrap'" @click.stop="confirm">
                        <span v-if="isCountDown">({{ seconds }})秒 同意并确认签属产品协议</span>
                        <span v-if="!isCountDown && disabled">同意并确认签属产品协议</span>
                        <span v-if="disabled" class="slide">（协议内容下滑到底部并阅读完毕即可点击）</span>
                        <span v-if="!disabled && !isCountDown">同意并确认签属产品协议</span>
                    </div>
                </div>
            </div>
        </div>
    </vb-mask>
</template>

<script>
import buyreceipt from '@/www/components/outside/open/treaty/buyreceipt/index.vue';
import vbMask from '@/www/components/vbMask/index.vue';
export default {
    name: 'agreementPurchase',
    components: {
        buyreceipt,
        vbMask,
    },
    props: {
        downloadShow: {
            type: Boolean,
            default: true,
        },
        show: {
            type: Boolean,
            default: false,
        },
        dealLists: {
            type: Array,
            default: () => [],
        },
        isShowFooter: {
            type: Boolean,
            default: true,
        },
    },
    data() {
        return {
            choseItem: {},
            orderId: '',
            userSign: '',
            disabled: true,
            seconds: 0,
            isPullDown: false,
            btnType: 0,
            isCountDown: true,
            isShow: this.show,
            dealList: [],
            activeName: '',
            leftFlag: false,
            rightFlag: false,
            showIndex: 0,
            isAnalysis: false, //是否已经加载过合同
            isSwitch: false, //切换合同
            timer: null,
        };
    },
    watch: {
        show(val) {
            this.isShow = val;
        },
        dealLists: {
            handler(val) {
                this.dealList = val;
                if (val.length) {
                    this.activeName = val[0].productId;
                }
            },
            deep: true,
            immediate: true,
        },
    },
    mounted() {},
    methods: {
        areaChange(area) {},
        open(item, orderId, userSign) {
            this.orderId = orderId;
            this.userSign = userSign;
            this.choseItem = item || {};
        },
        changeDeal(item, index) {
            this.isSwitch = true;
            // this.orderId = item.orderNo;
            this.choseItem = item || {};
            this.showIndex = index;
        },
        close() {
            this.isShow = false;
            clearTimeout(this.timer);
            this.$emit('close-fn');
        },
        scrollFn(e) {
            if (this.btnType === 1 || this.btnType === 3) {
                let offsetHeight = e.target.offsetHeight;
                let scrollHeight = e.target.scrollHeight;
                let scrollTop = e.target.scrollTop;
                if (offsetHeight + scrollTop + 10 >= scrollHeight && !this.isSwitch) {
                    this.disabled = false;
                }
            }
        },
        confirm() {
            if (this.btnType === 1) {
                if (this.disabled) {
                    return false;
                }
            } else if (this.btnType === 2) {
                if (this.isCountDown) {
                    return false;
                }
            } else if (this.btnType === 3) {
                if (this.disabled || this.isCountDown) {
                    return false;
                }
            }
            this.isShow = false;
            clearTimeout(this.timer);
            this.$emit('confirm-fn');
        },
        countDown() {
            this.seconds = this.seconds - 1;
            if (this.seconds <= 0) {
                this.isCountDown = false;
                clearTimeout(this.timer);
                return;
            }
            this.timer = setTimeout(this.countDown, 1000);
        },
        /**
         * @description 多协议时判断协议长度
         */
        multiProtocol() {
            if (this.dealList.length < 2) {
                return false;
            }
            let wrapWidth = this.$refs.contentItemWrap.offsetWidth;
            if (wrapWidth > 836) {
                this.rightFlag = true;
            }
            this.showIndex = 0;
        },
        preFn() {
            this.rightFlag = true;
            //获取当前位移
            let offset = parseFloat(this.$refs.contentItemWrap.style.left) || 0;
            //每次位移150px
            if (offset + 150 < 0) {
                this.$refs.contentItemWrap.style.left = `${offset + 150}px`;
            } else {
                this.$nextTick(() => {
                    this.leftFlag = false;
                });
                this.$refs.contentItemWrap.style.left = `0px`;
            }
        },
        nextFn() {
            this.leftFlag = true;
            //获取当前位移
            let offset = parseFloat(this.$refs.contentItemWrap.style.left) || 0;
            //获取最大可位移距离
            let maxOffset = this.$refs.contentItemWrap.offsetWidth - 836;
            //每次位移150px
            if (offset - 150 > -maxOffset) {
                this.$refs.contentItemWrap.style.left = `${offset - 150}px`;
            } else {
                this.$refs.contentItemWrap.style.left = `${-maxOffset}px`;
                this.$nextTick(() => {
                    this.rightFlag = false;
                });
            }
        },
        setUp({ seconds = 0, isPullDown = false }) {
            this.btnType = NaN;
            this.seconds = seconds;
            this.isPullDown = isPullDown;
            //“阅读时间”为空，强制下拉到底为“是”
            if (!this.seconds && this.isPullDown) {
                this.btnType = 1;
                this.disabled = true;
            } else if (this.seconds && !this.isPullDown) {
                //“阅读时间”不为空，强制下拉到底为“否”
                this.btnType = 2;
            } else if (this.seconds && this.isPullDown) {
                //“阅读时间”不为空，强制下拉到底为“是”
                this.btnType = 3;
                this.disabled = true;
            } else {
                this.btnType = 0;
            }
        },
        //合同生成后
        analysis() {
            this.isSwitch = false;
            if (!this.isAnalysis) {
                this.isAnalysis = true;
                this.isCountDown = true;
                this.countDown();
                this.multiProtocol();
            }
            if (this.btnType == 0) {
                this.disabled = false;
            }
        },
    },
};
</script>

<style scoped lang="less">
.greementWrap {
    width: 900px;
    border-radius: 4px;
    background: #fff;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 4000;
    .gteementTitle {
        height: 75px;
        background: #ffffff;
        box-shadow: 0px 4px 10px 0px rgba(68, 68, 68, 0.05);
        color: #3e3a39;
        font-size: 20px;
        text-align: center;
        line-height: 75px;
    }
    .close {
        width: 15px;
        height: 15px;
        background: url('./asset/images/close1.png') no-repeat 0 0 / cover;
        cursor: pointer;
        position: absolute;
        right: 20px;
        top: 27px;
    }
    .closes {
        width: 28px;
        height: 28px;
        background: url('./asset/images/close2.png') no-repeat center center;
        position: absolute;
        top: -44px;
        right: 0px;
        cursor: pointer;
    }
    .greementCont {
        height: 500px;
        overflow-y: auto;
        padding: 0 48px;
    }
    .footer {
        height: 90px;
        display: flex;
        justify-content: center;
        align-items: center;
        > div {
            width: 390px;
            height: 50px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            span {
                display: inline-block;
                height: 16px;
                font-size: 16px;
                font-weight: 700;
                line-height: 16px;
            }
        }
        .btn-wrap {
            background: linear-gradient(135deg, #ff0000, #ff4c3d 98%);
            cursor: pointer;
            span {
                color: #fff;
            }
        }
        .disable {
            background-color: #d4d9e2;
            opacity: 0.5;
            span {
                color: #a5aabb;
                &.slide {
                    font-size: 12px;
                    font-weight: 400;
                    height: 16px;
                    line-height: 16px;
                }
            }
        }
    }
    .multi-protocol {
        box-sizing: border-box;
        width: 900px;
        overflow: hidden;
        position: relative;
        padding: 23px 32px 14px;
        .fn {
            width: 75px;
            height: 75px;
            position: absolute;
            top: 0;
            background-color: #fff;
            z-index: 99;
            img {
                position: absolute;
                cursor: pointer;
                top: 39px;
                width: 20px;
                height: 20px;
            }
            &.left {
                left: 0;
                // background: linear-gradient(270deg, #ffffff 50%, rgba(255, 255, 255, 0));
                img {
                    left: 16px;
                }
            }
            &.right {
                right: 0;
                // background: linear-gradient(270deg, #ffffff 37%, rgba(255, 255, 255, 0));
                img {
                    right: 16px;
                }
            }
        }
        .multi-protocol-content {
            height: 38px;
            line-height: 38px;
            text-align: left;
            width: 5000px;
            position: relative;
            .content-item-wrap {
                position: absolute;
                top: 0;
                left: 0;
                display: inline-block;
                height: 38px;
                transition: all 1s linear;
            }
            .content-item {
                display: inline-block;
                opacity: 0.8;
                background: #f6f7f8;
                border-radius: 19px;
                margin-right: 16px;
                padding: 12px 18px 12px 20px;
                font-size: 14px;
                font-family: MicrosoftYaHei, MicrosoftYaHei-Regular;
                font-weight: 400;
                color: #53586c;
                line-height: 14px;
                cursor: pointer;
                &:last-child {
                    margin-right: 0px;
                }
                &.active {
                    opacity: 1;
                    background: linear-gradient(135deg, #ff0000, #ff4c3d 98%);
                    border-radius: 25px;
                    font-weight: 700;
                    color: #ffffff;
                }
            }
        }
    }
}
</style>
